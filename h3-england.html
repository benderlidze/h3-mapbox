<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Add a default marker to a web map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/h3-js"></script>
    <script src="https://unpkg.com/deck.gl@^8.0.0/dist.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiaHVuZ3VuY2hhaW5lZCIsImEiOiJjbDFieGZyMDgwMjR3M2twMmJ1bTdlZW5wIn0.dQYKVbIDvcw65XPddVznCg';
        const map = new mapboxgl.Map({
            container: 'map',
            zoom: 5.5,
            center: { lng: -3.375524309047023, lat: 54.74094135942198 },
            // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
            style: 'mapbox://styles/mapbox/light-v11',
            antialias: true, // create the gl context with MSAA antialiasing, so custom layers are antialiased
            projection: 'mercator'
        });

        map.on("load", () => {

            d3.csv("Hex Ids.csv")
                .then(data => {
                    console.log('data', data);

                    const polygons = data.map(hex => {
                        const polygon = {
                            "type": "Feature",
                            "properties": {},
                            "geometry": {
                                "type": "Polygon",
                                "coordinates": [
                                    h3.cellToBoundary(hex.h3, true)
                                ]
                            }
                        }
                        return polygon;
                    })

                    const collection = {
                        "type": "FeatureCollection",
                        "features":
                            polygons
                    }
                    map.getSource("hex").setData(collection)
                })

            map.addSource('bbox', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': []
                }
            });

            map.addLayer({
                'id': 'bbox-fills',
                'type': 'fill',
                'source': 'bbox',
                'layout': {},
                'paint': {
                    'fill-color': '#627BC1',
                    'fill-opacity': 0.3
                }
            });


            map.addSource('hex', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': []
                }
            });

            map.addLayer({
                'id': 'hex-fills',
                'type': 'fill',
                'source': 'hex',
                'layout': {},
                'paint': {
                    'fill-color': '#627BC1',
                    'fill-opacity': 0.6
                }
            });

            map.addLayer({
                'id': 'hex-borders',
                'type': 'line',
                'source': 'hex',
                'layout': {},
                'paint': {
                    'line-color': 'white',
                    'line-width': 2
                }
            });

            const eng = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {},
                        "geometry": {
                            "coordinates": [
                                [
                                    [
                                        -5.618247533656984,
                                        50.11322289865171
                                    ],
                                    [
                                        -5.338486038155935,
                                        50.012202142661124
                                    ],
                                    [
                                        -4.534171738589208,
                                        50.370421154781155
                                    ],
                                    [
                                        -3.9221934578119715,
                                        50.28111831429149
                                    ],
                                    [
                                        -3.4126964657640144,
                                        50.5374119865306
                                    ],
                                    [
                                        -2.9755691275923937,
                                        50.70381367520406
                                    ],
                                    [
                                        -1.9964038873335426,
                                        50.61513936240101
                                    ],
                                    [
                                        -1.1944749432152548,
                                        50.80337215649439
                                    ],
                                    [
                                        0.25678783355596124,
                                        50.803372125340246
                                    ],
                                    [
                                        1.2884084071794746,
                                        51.045846458323865
                                    ],
                                    [
                                        1.200982939835626,
                                        51.36354297065165
                                    ],
                                    [
                                        0.6939152292384563,
                                        51.47258574445323
                                    ],
                                    [
                                        0.9212214443336961,
                                        51.722397734631016
                                    ],
                                    [
                                        1.3933189679928262,
                                        51.96006384280784
                                    ],
                                    [
                                        1.7255357439004797,
                                        52.53811758442029
                                    ],
                                    [
                                        1.253438220241378,
                                        52.89822093413852
                                    ],
                                    [
                                        0.4840941076127194,
                                        52.89822093413852
                                    ],
                                    [
                                        0.15187733170503748,
                                        52.78204216597271
                                    ],
                                    [
                                        -0.005488509514947282,
                                        52.929852126020876
                                    ],
                                    [
                                        0.23930279904888607,
                                        53.18207075190165
                                    ],
                                    [
                                        0.11690714476699782,
                                        53.49527097007251
                                    ],
                                    [
                                        -0.09291397685876746,
                                        53.95047959640232
                                    ],
                                    [
                                        -0.5650115005178691,
                                        54.47195925517613
                                    ],
                                    [
                                        -1.1070493980521974,
                                        54.684776132111125
                                    ],
                                    [
                                        -1.509206547835106,
                                        55.27675961196201
                                    ],
                                    [
                                        -1.806453136805601,
                                        55.712574431233094
                                    ],
                                    [
                                        -2.5408270624971294,
                                        56.04604571056123
                                    ],
                                    [
                                        -3.222745707781968,
                                        55.93847131021758
                                    ],
                                    [
                                        -3.0653798665619547,
                                        56.15332098675043
                                    ],
                                    [
                                        -2.6981929037161763,
                                        56.24086949727115
                                    ],
                                    [
                                        -2.610767436372356,
                                        56.502317944670125
                                    ],
                                    [
                                        -2.435916501683778,
                                        56.81943550673407
                                    ],
                                    [
                                        -2.1911251931199445,
                                        57.1623468119231
                                    ],
                                    [
                                        -1.893878604149478,
                                        57.389202893577504
                                    ],
                                    [
                                        -1.7539978563989962,
                                        57.49271198815774
                                    ],
                                    [
                                        -2.121184819244718,
                                        57.66145955577855
                                    ],
                                    [
                                        -3.082864960031486,
                                        57.66145955577855
                                    ],
                                    [
                                        -3.922149446535343,
                                        57.59592846841932
                                    ],
                                    [
                                        -4.219396035505923,
                                        57.51150037121528
                                    ],
                                    [
                                        -4.04454510081726,
                                        57.82011476530488
                                    ],
                                    [
                                        -3.9046643530668064,
                                        58.01514111317934
                                    ],
                                    [
                                        -3.4325668294076763,
                                        58.23673400679917
                                    ],
                                    [
                                        -3.1702904273753063,
                                        58.38369804721313
                                    ],
                                    [
                                        -3.100350053500051,
                                        58.630317884782414
                                    ],
                                    [
                                        -4.009574913880158,
                                        58.54830375288637
                                    ],
                                    [
                                        -4.778919026508817,
                                        58.55742592962741
                                    ],
                                    [
                                        -5.0237103350726215,
                                        58.57566315921957
                                    ],
                                    [
                                        -5.495807858731752,
                                        58.116875616660025
                                    ],
                                    [
                                        -5.600718357597685,
                                        57.838734247804496
                                    ],
                                    [
                                        -5.8366063472511485,
                                        57.332793261294285
                                    ],
                                    [
                                        -6.273733683972154,
                                        57.661631383726444
                                    ],
                                    [
                                        -6.588465366411242,
                                        57.49288461468919
                                    ],
                                    [
                                        -6.273733683972154,
                                        57.15303835121995
                                    ],
                                    [
                                        -5.993972116161501,
                                        57.07708955958762
                                    ],
                                    [
                                        -5.819121113069798,
                                        56.858333050906765
                                    ],
                                    [
                                        -6.2562484497908315,
                                        56.6282057001537
                                    ],
                                    [
                                        -6.2737335432603345,
                                        56.39666646175465
                                    ],
                                    [
                                        -5.784150926132639,
                                        56.377307641453115
                                    ],
                                    [
                                        -5.591814897975496,
                                        56.21236004389144
                                    ],
                                    [
                                        -6.483554664886071,
                                        55.81160963483177
                                    ],
                                    [
                                        -6.413614291010816,
                                        55.63435481238383
                                    ],
                                    [
                                        -6.063912421633631,
                                        55.63435481238383
                                    ],
                                    [
                                        -5.661755271850723,
                                        55.85089039618231
                                    ],
                                    [
                                        -5.749180739194571,
                                        55.3271932111104
                                    ],
                                    [
                                        -5.347023589411634,
                                        55.64422341778507
                                    ],
                                    [
                                        -5.137202467784988,
                                        55.53553195878112
                                    ],
                                    [
                                        -4.909896252690601,
                                        55.66395317112273
                                    ],
                                    [
                                        -4.700075131063983,
                                        55.57509095671878
                                    ],
                                    [
                                        -5.207142841660215,
                                        55.067724311786634
                                    ],
                                    [
                                        -4.909896252690601,
                                        54.735959147982754
                                    ],
                                    [
                                        -4.018156485779116,
                                        54.82671174138673
                                    ],
                                    [
                                        -3.511088775182884,
                                        54.887100391024234
                                    ],
                                    [
                                        -3.5460589621209806,
                                        54.553842494342064
                                    ],
                                    [
                                        -3.336237840494249,
                                        54.24849874369323
                                    ],
                                    [
                                        -3.0215061580552174,
                                        54.074460348663536
                                    ],
                                    [
                                        -2.8466552233665823,
                                        53.84814635786995
                                    ],
                                    [
                                        -3.0389912515237825,
                                        53.49596754343705
                                    ],
                                    [
                                        -3.9307310184352957,
                                        53.26651610996538
                                    ],
                                    [
                                        -4.507739102906783,
                                        53.412673701055695
                                    ],
                                    [
                                        -4.700075131063983,
                                        53.20372372617089
                                    ],
                                    [
                                        -4.315403074749639,
                                        53.00427305300232
                                    ],
                                    [
                                        -4.700075131063983,
                                        52.82503250141639
                                    ],
                                    [
                                        -4.105581953123874,
                                        52.79332478093406
                                    ],
                                    [
                                        -4.088096859654371,
                                        52.485623341197964
                                    ],
                                    [
                                        -4.7875005984087124,
                                        52.03614223400291
                                    ],
                                    [
                                        -5.224627935129718,
                                        51.87450788424067
                                    ],
                                    [
                                        -4.96235153309641,
                                        51.6580882437199
                                    ],
                                    [
                                        -4.297917981281017,
                                        51.6580882437199
                                    ],
                                    [
                                        -3.7034248033400274,
                                        51.4842049024266
                                    ],
                                    [
                                        -3.073961438461822,
                                        51.38610309061605
                                    ],
                                    [
                                        -3.0564763449932855,
                                        51.254972798777004
                                    ],
                                    [
                                        -4.0706117661857775,
                                        51.26591464334436
                                    ],
                                    [
                                        -4.647619850657321,
                                        50.80411207911652
                                    ],
                                    [
                                        -5.119717374316366,
                                        50.426896144462916
                                    ],
                                    [
                                        -5.618247533656984,
                                        50.11322289865171
                                    ]
                                ]
                            ],
                            "type": "Polygon"
                        }
                    }
                ]
            }

            // map.on("moveend", () => {

            //     if (map.getZoom() < 4) return;



            //     console.log('JSON.s', JSON.stringify(geojson));
            // })

            var line = turf.lineString(map.getBounds().toArray());
            var bboxLine = turf.bbox(line);
            var bboxPolygon = turf.bboxPolygon(bboxLine);
            const bbox = bboxPolygon.geometry.coordinates.splice(0, 3)

            //var hexagons = h3.polygonToCells(bbox, 5, true);
            var hexagons = h3.polygonToCells(eng.features[0].geometry.coordinates, 5, true);

            var geojson = {
                type: 'Feature',
                geometry: {
                    type: 'MultiPolygon',
                    coordinates: hexagons.map(function toBoundary(hex) {
                        return [h3.cellToBoundary(hex, true)];
                    })
                }
            };
            map.getSource("bbox").setData(geojson)

        })

    </script>

</body>

</html>